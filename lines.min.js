function arrayUnique(e){for(var t=[],n=0;n<e.length;n++){for(var r=!1,a=0;a<t.length;a++)e[n][0]==t[a][0]&&e[n][1]==t[a][1]&&(r=!0);0==r&&t.push([e[n][0],e[n][1]])}return t}function hhhh(e){return e=""+e,e=e.substr(0,e.length-2),parseInt(e)}function init(){POINTS=0,document.getElementById("points")&&(document.getElementById("points").innerHTML=POINTS),document.getElementById("pright")&&(document.getElementById("pright").innerHTML=POINTS),AREA=[],NEXTCOLORS=[],ACTIVE=!1,TIMER=!1;for(var e=0;SIZE>e;e++){for(var t=[],n=0;SIZE>n;n++)t.push(0);AREA.push(t)}var r=document.createElement("table");r.setAttribute("id","area");for(var a=document.createElement("tbody"),e=0;SIZE>e;e++){for(var l=document.createElement("tr"),n=0;SIZE>n;n++){var i=document.createElement("td");i.setAttribute("x",e),i.setAttribute("y",n),i.style.verticalAlign="top",i.onclick=function(){move2(this.getAttribute("x"),this.getAttribute("y"))},l.appendChild(i)}a.appendChild(l)}r.appendChild(a),document.getElementById("main").innerHTML="",document.getElementById("points")&&(document.getElementById("points").innerHTML="0"),document.getElementById("main").appendChild(r),addBalls()}function checkRegister(){for(var e=0,t=0;SIZE>t;t++)for(var n=0;SIZE>n;n++)AREA[t][n]>0&&e++;return e>=SIZE*SIZE?(register(),!0):!1}function checkMove(e,t,n,r){for(var a=buildPath(parseInt(e),parseInt(t),[],n,r),l=0;l<a.length;l++)if(a[l][0]==parseInt(n)&&a[l][1]==parseInt(r))return a;return!1}function buildPath(e,t,n,r,a){n=n||[];for(var l=-1;1>=l;l++)for(var i=-1;1>=i;i++)if((0==l||0==i)&&e+l>=0&&SIZE>e+l&&t+i>=0&&SIZE>t+i&&0==AREA[e+l][t+i]){for(var o=!0,s=0;s<n.length;s++)n[s][0]==e+l&&n[s][1]==t+i&&(o=!1);if(o){if(n.push([e+l,t+i]),r&&a&&e+l==r&&t+i==a)return n;n=buildPath(e+l,t+i,n,r,a)}}return n}function move2(e,t){ACTIVE&&0==AREA[e][t]&&(clearTimeout(TIMER),(path=checkMove(ACTIVE[0],ACTIVE[1],e,t))?(addBallTo(e,t,ACTIVE[2]),delBallFrom(ACTIVE[0],ACTIVE[1]),check(!0)||addBalls(),ACTIVE=!1):alert("This ball is blocked by another ball!"))}function move(){if(!checkRegister()){if(ACTIVE){if(ACTIVE[5]<-6&&(ACTIVE[4]=2),ACTIVE[5]>5){ACTIVE[4]=-2;var e=document.getElementById("music"),t=document.getElementById("music2");t&&t.Play?t.Play():e&&(e.innerHTML='<audio autoplay id="music2" src="/games/shariki-linii/ball.wav"></audio>')}ACTIVE[5]+=ACTIVE[4],ACTIVE[3].style.top=hhhh(ACTIVE[3].style.top)+ACTIVE[4]+"px"}TIMER&&clearTimeout(TIMER),TIMER=setTimeout("move()",100)}}function check(e){for(var e=e||!1,t=!1,n=[],r=[],a=0;SIZE>a;a++)for(var l=0;SIZE>l;l++)if(AREA[a][l]>0)if(SIZE-1>l&&AREA[a][l]==AREA[a][l+1])n.push([a,l]);else{if(n.length>=4){for(var i=0;i<n.length;i++)r.push([n[i][0],n[i][1]]);r.push([a,l]),n=[],t=!0}n=[]}n=[];for(var l=0;SIZE>l;l++)for(var a=0;SIZE>a;a++)if(AREA[a][l]>0)if(SIZE-1>a&&AREA[a][l]==AREA[a+1][l])n.push([a,l]);else{if(n.length>=4){for(var i=0;i<n.length;i++)r.push([n[i][0],n[i][1]]);r.push([a,l]),n=[],t=!0}n=[]}f=[];for(var a=0;SIZE>a;a++)for(var l=0;SIZE>l;l++){f=[];for(var o=0;SIZE>o;o++)if(SIZE>a+o&&SIZE>l+o&&AREA[a+o][l+o]>0)if(SIZE-1>a+o&&SIZE-1>l+o&&AREA[a+o][l+o]==AREA[a+o+1][l+o+1])f.push([a+o,l+o]);else{if(f.length>=4){for(var s=0;s<f.length;s++)r.push([f[s][0],f[s][1]]);r.push([a+o,l+o]),f=[],t=!0}f=[]}}f=[];for(var a=0;SIZE>a;a++)for(var l=0;SIZE>l;l++){f=[];for(var o=0;SIZE>o;o++)if(SIZE>a+o&&l-o>=0&&AREA[a+o][l-o]>0)if(SIZE-1>a+o&&l-o>0&&AREA[a+o][l-o]==AREA[a+o+1][l-o-1])f.push([a+o,l-o]);else{if(f.length>=4){for(var s=0;s<f.length;s++)r.push([f[s][0],f[s][1]]);r.push([a+o,l-o]),f=[],t=!0;break}f=[]}}return r.length>0?(delBalls(arrayUnique(r),e),document.getElementById("points")&&(document.getElementById("points").innerHTML=POINTS),document.getElementById("pright")&&(document.getElementById("pright").innerHTML=POINTS),moveResults()):checkRegister(),t}function delRandomBalls(e){for(var t=0,n=0;SIZE>n;n++)for(var r=0;SIZE>r;r++)AREA[n][r]>0&&(t+=1);e>=t&&(e=t-1);for(var a=[];a.length<e;){var n=parseInt(Math.random()*SIZE),r=parseInt(Math.random()*SIZE);AREA[n][r]>0&&a.push([n,r]),a>=e&&(a=arrayUnique(a))}delBalls(arrayUnique(a),!0),document.getElementById("points").innerHTML=POINTS,moveResults()}function addBalls(){addBall(),addBall(),addBall(),document.getElementById("next").innerHTML="";var e=document.createElement("table"),t=document.createElement("tbody"),n=document.createElement("tr");for(i=0;i<NEXTCOLORS.length;i++){var r=document.createElement("td");r.style.verticalAlign="top",r.style.textAlign="center";var a=new Image;a.style.width="20px",a.style.height="20px",a.style.position="relative",a.style.top="5px",a.setAttribute("src",COLORS[NEXTCOLORS[i]]),r.appendChild(a),n.appendChild(r)}t.appendChild(n),e.appendChild(t),document.getElementById("next").appendChild(e);var l=check(!1);!l&&checkRegister()&&register()}function addBall(){if(!checkRegister()){var e=parseInt(Math.random()*SIZE),t=parseInt(Math.random()*SIZE),n=parseInt(Math.random()*COLORS.length);0==AREA[e][t]?NEXTCOLORS.length>=3?(NEXTCOLORS=[n,NEXTCOLORS[0],NEXTCOLORS[1],NEXTCOLORS[2]],addBallTo(e,t,NEXTCOLORS.pop())):(addBallTo(e,t,n),NEXTCOLORS.push(parseInt(Math.random()*COLORS.length))):addBall()}}function delTimer(e,t){var n=document.getElementById("area").rows[e].cells[t].childNodes[0];n.getAttribute("time")||n.setAttribute("time",10),parseInt(n.getAttribute("time"))>1?(n.style.top=hhhh(n.style.top)+parseInt(n.getAttribute("time"))*Math.pow(-1,parseInt(n.getAttribute("time")))+"px",n.setAttribute("time",parseInt(n.getAttribute("time"))-1),setTimeout("delTimer("+e+","+t+")",50)):delBallFrom(e,t)}function delBalls(e,t){var t=t||!1;if(t)switch(e.length){case 5:POINTS+=10;break;case 6:POINTS+=12;break;case 7:POINTS+=18;break;case 8:POINTS+=28;break;case 9:POINTS+=42;break;case 10:POINTS+=58;break;case 11:POINTS+=72;break;case 12:POINTS+=88;break;case 13:POINTS+=102;break;case 14:POINTS+=118;break;case 15:POINTS+=132;break;case 16:POINTS+=148;break;case 17:POINTS+=162;break;case 18:POINTS+=178;break;case 19:POINTS+=192;break;case 20:POINTS+=206}for(var n=0;n<e.length;n++)delTimer(e[n][0],e[n][1])}function delBallFrom(e,t){AREA[e][t]=0,document.getElementById("area").rows[e].cells[t].innerHTML=""}function addBallTo(e,t,n){AREA[e][t]=n+1;var r=new Image;r.style.position="relative",r.style.top="5px",r.onclick=function(){return function(e,t,n,r){ACTIVE&&(ACTIVE[3].style.top="5px"),ACTIVE=[e,t,n,r,2,0],move()}(e,t,n,this)},r.setAttribute("src",COLORS[n]),document.getElementById("area").rows[e].cells[t].innerHTML="",document.getElementById("area").rows[e].cells[t].appendChild(r)}function sortNumber(e,t){return parseInt(t)-parseInt(e)}function sort(e){for(var t,n,r,a=e.innerHTML,l=e.parentNode,i=l.parentNode,o=0;t=l.getElementsByTagName("td").item(o);o++)t.innerHTML==a?(r=o,"y"==t.prevsort?(n=t.firstChild,e.up=Number(!e.up)):(t.prevsort="y",n=t.insertBefore(document.createElement("span"),t.firstChild),e.up=0),n.innerHTML=e.up?"&#8593; ":"&#8595; "):"y"==t.prevsort&&(t.prevsort="n",t.firstChild&&t.removeChild(t.firstChild));var s=new Array;for(o=1;o<i.rows.length;o++)s[o-1]=new Array,s[o-1][0]=i.rows[o].getElementsByTagName("td").item(2).innerHTML,s[o-1][1]=i.rows[o];for(s.sort(sortNumber),o=0;o<s.length;o++)i.appendChild(s[o][1])}function moveResults(){document.getElementById("results")&&sort(document.getElementById("results").rows[0].cells[2])}function upVoin(){var e=parseInt($("#pleft").html()),t=parseInt($("#pright").html()),n=0;if(e>=t){var n=t/e*260;$("#voin").height(448-n),$("#bvoin").height(1+n)}else n=260-e/t*260,$("#voin").height(188),$("#bvoin").height(261),$("#korol").height(189+n),$("#bkorol").height(260-n);setTimeout(upVoin,1e3)}function checkForm(){return""==$.trim($("#name").val())||$.trim($("#name").val()).length<3?(alert("Имя должно быть не меньше 3 символов."),!1):!0}function register(){document.getElementById("point").value=POINTS,document.getElementById("regis").style.display="block"}function snreg(e){var t="//ulogin.ru/token.php?host="+encodeURIComponent(location.toString())+"&token="+e+"&callback=?";$.get(t,{from:"BillGates"},null,"jsonp").done(function(e){e=$.parseJSON(e.toString()),$("#name").val(e.last_name+" "+e.first_name),$("#email").val(e.email),$("#vk").val(e.uid),$("#network").val(e.profile),reg_form.submit()})}var COLORS=["green.png","blue.png","pink.png","yellow.png","brown.png","red.png","navy.png"],TIMER=!1,ACTIVE=!1,POINTS=0,SIZE=9,NEXTCOLORS=[],AREA=[];init(),setTimeout(upVoin,1e3);
